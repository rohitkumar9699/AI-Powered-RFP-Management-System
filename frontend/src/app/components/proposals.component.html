<div class="card">
  <div class="card-header">
    <h4>Proposals & Evaluation</h4>
  </div>
  
  <div class="card-body">
    <!-- Email & Evaluation Actions -->
    <div class="card bg-light mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <button type="button" class="btn btn-primary w-100" (click)="checkForEmails()" [disabled]="checkingEmails">
              {{ checkingEmails ? 'Checking Emails...' : 'üìß Check for Incoming Proposals' }}
            </button>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <select class="form-select" [(ngModel)]="selectedRFPId" name="rfpSelect">
                <option value="">Select RFP to Evaluate...</option>
                <option *ngFor="let rfp of rfps" [value]="rfp.id">
                  {{ rfp.title }} (Status: {{ rfp.status }})
                </option>
              </select>
              <button type="button" class="btn btn-warning" (click)="evaluateProposals()" [disabled]="!selectedRFPId || isLoading">
                {{ isLoading ? 'Evaluating...' : 'Compare & Evaluate' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Evaluation Results -->
    <div *ngIf="showEvaluation && evaluationResult" class="card bg-success bg-opacity-10 mb-4">
      <div class="card-header bg-success text-white">
        <h5>Evaluation Results & Recommendation</h5>
      </div>
      <div class="card-body">
        <div *ngIf="evaluationResult.summary" class="mb-3">
          <h6>Summary:</h6>
          <p>{{ evaluationResult.summary }}</p>
        </div>

        <div *ngIf="evaluationResult.recommendation" class="alert alert-success">
          <h6>üèÜ Recommendation:</h6>
          <p>{{ evaluationResult.recommendation }}</p>
        </div>

        <!-- Individual Scores -->
        <div *ngIf="evaluationResult.evaluations" class="mt-4">
          <h6>Detailed Evaluations:</h6>
          <div class="row">
            <div *ngFor="let vendorEval of evaluationResult.evaluations | keyvalue" class="col-md-6 mb-3">
              <div class="card border-info">
                <div class="card-header bg-light">
                  <h6 class="mb-0">{{ vendorEval.key }}</h6>
                </div>
                <div class="card-body">
                  <div class="mb-2">
                    <small><strong>Overall Score:</strong></small>
                    <div class="progress">
                      <div class="progress-bar" 
                        [style.width.%]="vendorEval.value.score || 0">
                        {{ vendorEval.value.score || 0 }}/100
                      </div>
                    </div>
                  </div>
                  <div class="mb-2">
                    <small><strong>Compliance Score:</strong> {{ vendorEval.value.compliance_score || 'N/A' }}/100</small>
                  </div>
                  <div class="mb-2">
                    <small><strong>Price Competitiveness:</strong> {{ vendorEval.value.price_competitiveness || 'N/A' }}/100</small>
                  </div>
                  <div *ngIf="vendorEval.value.risk_assessment" class="mb-2">
                    <small><strong>Risk Assessment:</strong> {{ vendorEval.value.risk_assessment }}</small>
                  </div>
                  <div *ngIf="vendorEval.value.notes" class="mt-2 p-2 bg-light rounded">
                    <small>{{ vendorEval.value.notes }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-secondary btn-sm mt-3" (click)="showEvaluation = false">
          Close Evaluation
        </button>
      </div>
    </div>

    <!-- Proposals List -->
    <div *ngIf="proposals.length > 0 && !showEvaluation; else noProposals">
      <h5 class="mb-3">All Proposals</h5>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Vendor</th>
              <th>RFP</th>
              <th>Price</th>
              <th>Delivery</th>
              <th>Warranty</th>
              <th>Score</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let proposal of proposals">
              <td><strong>{{ proposal.vendor_name }}</strong></td>
              <td>{{ proposal.rfp_id }}</td>
              <td>${{ proposal.price | number:'1.0-0' }}</td>
              <td>{{ proposal.delivery_time || 'Not specified' }}</td>
              <td>{{ proposal.warranty || 'N/A' }}</td>
              <td>
                <span *ngIf="proposal.score !== null" class="badge" [ngClass]="getScoreBadge(proposal.score)">
                  {{ proposal.score | number:'1.1-1' }}/100
                </span>
                <span *ngIf="proposal.score === null" class="text-muted">Not evaluated</span>
              </td>
              <td>
                <span class="badge" [ngClass]="getStatusBadge(proposal.status)">
                  {{ proposal.status }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-info" (click)="viewProposal(proposal)">View</button>
                  <button type="button" class="btn btn-outline-success" (click)="acceptProposal(proposal)" 
                    [disabled]="proposal.status === 'ACCEPTED'">Accept</button>
                  <button type="button" class="btn btn-outline-danger" (click)="deleteProposal(proposal)">Delete</button>
                  <button *ngIf="proposal.status === 'RECEIVED'" type="button" class="btn btn-outline-warning" 
                    (click)="parseProposal(proposal)" [disabled]="isLoading">
                    Parse
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-3 p-3 bg-light rounded">
        <small class="text-muted">
          Total Proposals: {{ proposals.length }} | 
          Average Score: {{ averageScore.toFixed(1) }}/100
        </small>
      </div>
    </div>

    <ng-template #noProposals>
      <div class="alert alert-info">
        No proposals found yet. 
        <button type="button" class="btn btn-sm btn-info" (click)="checkForEmails()" [disabled]="checkingEmails">
          Check for emails
        </button>
      </div>
    </ng-template>
  </div>
</div>

<!-- View Proposal Modal -->
<div class="modal fade" [class.show]="showViewModal" [style.display]="showViewModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Proposal Details - {{ selectedProposal?.vendor_name }}</h5>
        <button type="button" class="btn-close" (click)="closeViewModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedProposal">
        <div class="row">
          <div class="col-md-6">
            <h6>Basic Information</h6>
            <p><strong>Vendor:</strong> {{ selectedProposal.vendor_name }}</p>
            <p><strong>RFP ID:</strong> {{ selectedProposal.rfp_id }}</p>
            <p><strong>Status:</strong> 
              <span class="badge" [ngClass]="getStatusBadge(selectedProposal.status)">
                {{ selectedProposal.status }}
              </span>
            </p>
            <p><strong>Received:</strong> {{ selectedProposal.received_at | date:'medium' }}</p>
          </div>
          <div class="col-md-6">
            <h6>Proposal Details</h6>
            <p><strong>Price:</strong> ${{ selectedProposal.price | number:'1.0-0' }}</p>
            <p><strong>Delivery Time:</strong> {{ selectedProposal.delivery_time || 'Not specified' }}</p>
            <p><strong>Warranty:</strong> {{ selectedProposal.warranty || 'N/A' }}</p>
            <p><strong>Payment Terms:</strong> {{ selectedProposal.payment_terms || 'N/A' }}</p>
            <p *ngIf="selectedProposal.score"><strong>Score:</strong> {{ selectedProposal.score | number:'1.1-1' }}/100</p>
          </div>
        </div>
        <div class="mt-3">
          <h6>Proposal Content</h6>
          <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
            <pre style="white-space: pre-wrap; font-family: inherit;">{{ selectedProposal.proposal_content }}</pre>
          </div>
        </div>
        <div *ngIf="selectedProposal.parsed_data && Object.keys(selectedProposal.parsed_data).length > 0" class="mt-3">
          <h6>Parsed Data</h6>
          <div class="row">
            <div class="col-md-6" *ngFor="let item of selectedProposal.parsed_data | keyvalue">
              <small><strong>{{ item.key | titlecase }}:</strong> {{ item.value }}</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeViewModal()">Close</button>
        <button type="button" class="btn btn-success" (click)="acceptProposal(selectedProposal)" 
          [disabled]="selectedProposal?.status === 'ACCEPTED'">Accept Proposal</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" [class.show]="showConfirmModal" [style.display]="showConfirmModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ confirmTitle }}</h5>
        <button type="button" class="btn-close" (click)="closeConfirmModal()"></button>
      </div>
      <div class="modal-body">
        <p>{{ confirmMessage }}</p>
        <div *ngIf="confirmType === 'accept'" class="alert alert-info">
          <small>This will send an acceptance email to the vendor and update the proposal status.</small>
        </div>
        <div *ngIf="confirmType === 'delete'" class="alert alert-danger">
          <small>This action cannot be undone.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">Cancel</button>
        <button type="button" class="btn" [ngClass]="confirmType === 'delete' ? 'btn-danger' : 'btn-success'" 
          (click)="executeConfirmedAction()">{{ confirmActionText }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showViewModal || showConfirmModal"></div>